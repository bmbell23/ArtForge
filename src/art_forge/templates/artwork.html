{% extends "base.html" %}

{% block content %}
<div class="container artwork-detail">
    <div class="artwork-header">
        <div class="artwork-title-section">
            <h1>{{ artwork.title }}</h1>
            <div class="artwork-byline">
                <span>By <strong>{{ artwork.artist.username }}</strong></span>
                <span>•</span>
                <span>{{ artwork.created_at.strftime('%B %d, %Y') if artwork.created_at else 'Recently' }}</span>
                <span>•</span>
                <span>✨ {{ spark_count }} sparks</span>
            </div>
        </div>
        <a href="/art/{{ artwork.artist.username }}" class="btn-view-gallery">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span>View Gallery</span>
        </a>
    </div>
    
    {% if artwork.description %}
    <div style="background: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow);">
        <p style="color: var(--text-gray); line-height: 1.8; font-size: 1.1rem;">{{ artwork.description }}</p>
    </div>
    {% endif %}
    
    <!-- Image Gallery -->
    <div class="gallery-container">
        {% if artwork.images %}
        <div class="gallery-main">
            <img id="mainImage"
                 src="/art/uploads/{{ artwork.images[0].filename }}"
                 alt="{{ artwork.title }}"
                 class="gallery-main-image"
                 loading="eager"
                 onclick="openLightbox(0)"
                 oncontextmenu="return false;">

            {% if artwork.images|length > 1 %}
            <button class="gallery-nav gallery-prev" onclick="changeImage(-1)" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="gallery-nav gallery-next" onclick="changeImage(1)" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>

            <div class="gallery-counter">
                <span id="currentImageNum">1</span> / {{ artwork.images|length }}
            </div>
            {% endif %}
        </div>

        {% if artwork.images|length > 1 %}
        <div class="gallery-thumbnails">
            {% for image in artwork.images %}
            <div class="thumbnail-wrapper">
                <img src="/art/uploads/{{ image.filename }}"
                     alt="{{ artwork.title }}"
                     class="gallery-thumbnail {% if loop.index0 == 0 %}active{% endif %}"
                     loading="{% if loop.index0 < 3 %}eager{% else %}lazy{% endif %}"
                     onclick="setImage({{ loop.index0 }})"
                     oncontextmenu="return false;">
                {% if is_owner and artwork.images|length > 1 %}
                <button class="thumbnail-delete"
                        onclick="event.stopPropagation(); deleteImage({{ image.id }}, '{{ image.filename }}')"
                        title="Delete this image">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">×</button>
        <img id="lightboxImage" src="" alt="" onclick="event.stopPropagation()">

        {% if artwork.images|length > 1 %}
        <button class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); changeLightboxImage(-1)" aria-label="Previous">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <button class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); changeLightboxImage(1)" aria-label="Next">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
        {% endif %}
    </div>

    <!-- Spark Button -->
    <div class="spark-section">
        <form method="POST" action="/art/{{ artwork.artist.username }}/{{ artwork.slug }}/spark" style="margin: 0;">
            <button type="submit" class="spark-button {% if user_has_sparked %}sparked{% endif %}">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if user_has_sparked %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                    <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>
                </svg>
                <span>{{ spark_count }} {% if spark_count == 1 %}Spark{% else %}Sparks{% endif %}</span>
            </button>
        </form>
    </div>

    <!-- Comments Section -->
    <div id="comments" class="comments-section">
        <h2>Comments ({{ comments|length }})</h2>

        {% if artwork.allow_comments %}
        <div class="comment-form-container">
            <h3>Leave a Comment</h3>
            <form method="POST" action="/art/{{ artwork.artist.username }}/{{ artwork.slug }}/comment" class="comment-form">
                {% if not current_user %}
                <div class="form-group">
                    <label for="author_name">Your Name</label>
                    <input type="text" id="author_name" name="author_name" required maxlength="100" placeholder="Enter your name">
                </div>
                {% endif %}
                <div class="form-group">
                    <label for="content">Comment</label>
                    <textarea id="content" name="content" required rows="4" placeholder="Share your thoughts..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
        </div>
        {% endif %}

        <div class="comments-list">
            {% if comments %}
                {% for comment in comments %}
                <div class="comment">
                    <div class="comment-header">
                        <strong>{{ comment.author.username if comment.author else comment.author_name }}</strong>
                        <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') if comment.created_at else 'Recently' }}</span>
                    </div>
                    <div class="comment-content">{{ comment.content }}</div>
                    {% if current_user and (current_user.id == comment.author_id or current_user.id == artwork.artist_id) %}
                    <form method="POST" action="/art/{{ artwork.artist.username }}/{{ artwork.slug }}/comment/{{ comment.id }}/delete" style="margin-top: 0.5rem;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                        <button type="submit" class="btn-delete-comment">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
            {% endif %}
        </div>
    </div>

    {% if is_owner %}
    <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border-left: 4px solid var(--primary-purple);">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">You are viewing this as the owner.</p>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="/art/{{ artwork.artist.username }}" class="btn btn-secondary btn-small">Back to Gallery</a>
            <form method="POST" action="/art/{{ artwork.artist.username }}/{{ artwork.slug }}/delete" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this artwork? This cannot be undone.');">
                <button type="submit" class="btn btn-small" style="background: #EF4444; color: white; border: none; cursor: pointer;">Delete Artwork</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Image gallery data
const images = [
    {% for image in artwork.images %}
    "/art/uploads/{{ image.filename }}"{% if not loop.last %},{% endif %}
    {% endfor %}
];
let currentImageIndex = 0;

// Preload images for smoother transitions
const imageCache = {};
function preloadImage(src) {
    if (!imageCache[src]) {
        const img = new Image();
        img.src = src;
        imageCache[src] = img;
    }
}

// Preload adjacent images
function preloadAdjacentImages(index) {
    // Preload next image
    const nextIndex = (index + 1) % images.length;
    if (images[nextIndex]) {
        preloadImage(images[nextIndex]);
    }

    // Preload previous image
    const prevIndex = (index - 1 + images.length) % images.length;
    if (images[prevIndex]) {
        preloadImage(images[prevIndex]);
    }
}

// Preload all images on page load (in background)
window.addEventListener('load', function() {
    // Preload all images with slight delay to not block initial page load
    setTimeout(() => {
        images.forEach(src => preloadImage(src));
    }, 500);
});

// Delete individual image
function deleteImage(imageId, filename) {
    if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
        return;
    }

    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/art/{{ artwork.artist.username }}/{{ artwork.slug }}/delete-image/' + imageId;
    document.body.appendChild(form);
    form.submit();
}

// Change main image
function setImage(index) {
    currentImageIndex = index;
    const mainImg = document.getElementById('mainImage');

    // Add fade effect
    mainImg.style.opacity = '0.5';

    setTimeout(() => {
        mainImg.src = images[index];
        mainImg.style.opacity = '1';
        document.getElementById('currentImageNum').textContent = index + 1;

        // Update thumbnail active state
        document.querySelectorAll('.gallery-thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });

        // Preload adjacent images
        preloadAdjacentImages(index);
    }, 100);
}

function changeImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    setImage(currentImageIndex);
}

// Lightbox functions
function openLightbox(index) {
    currentImageIndex = index;
    document.getElementById('lightboxImage').src = images[index];
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';

    // Preload adjacent images when opening lightbox
    preloadAdjacentImages(index);
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
}

function changeLightboxImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    const lightboxImg = document.getElementById('lightboxImage');

    // Add fade effect for smoother transition
    lightboxImg.style.opacity = '0.5';

    setTimeout(() => {
        lightboxImg.src = images[currentImageIndex];
        lightboxImg.style.opacity = '1';
        setImage(currentImageIndex); // Also update main gallery

        // Preload adjacent images
        preloadAdjacentImages(currentImageIndex);
    }, 100);
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    if (lightbox.classList.contains('active')) {
        if (e.key === 'Escape') {
            closeLightbox();
        } else if (e.key === 'ArrowLeft') {
            changeLightboxImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeLightboxImage(1);
        }
    } else {
        if (e.key === 'ArrowLeft') {
            changeImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeImage(1);
        }
    }
});

// Touch/swipe support
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            // Swipe left - next image
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('active')) {
                changeLightboxImage(1);
            } else {
                changeImage(1);
            }
        } else {
            // Swipe right - previous image
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('active')) {
                changeLightboxImage(-1);
            } else {
                changeImage(-1);
            }
        }
    }
}

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

// Disable right-click on images
document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'IMG') {
        e.preventDefault();
        return false;
    }
});

// Disable drag on images
document.querySelectorAll('img').forEach(img => {
    img.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
    });
});
</script>
{% endblock %}

