{% extends "base.html" %}

{% block content %}
<div class="container artwork-detail">
    <div class="artwork-header">
        <h1>{{ artwork.title }}</h1>
        <div class="artwork-byline">
            <span>By <strong>{{ artwork.artist.username }}</strong></span>
            <span>•</span>
            <span>{{ artwork.created_at.strftime('%B %d, %Y') if artwork.created_at else 'Recently' }}</span>
            <span>•</span>
            <span>✨ {{ spark_count }} sparks</span>
        </div>
    </div>
    
    {% if artwork.description %}
    <div style="background: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow);">
        <p style="color: var(--text-gray); line-height: 1.8; font-size: 1.1rem;">{{ artwork.description }}</p>
    </div>
    {% endif %}
    
    <!-- Image Gallery -->
    <div class="gallery-container">
        {% if artwork.images %}
        <div class="gallery-main">
            <img id="mainImage"
                 src="/art/uploads/{{ artwork.images[0].filename }}"
                 alt="{{ artwork.title }}"
                 class="gallery-main-image"
                 onclick="openLightbox(0)"
                 oncontextmenu="return false;">

            {% if artwork.images|length > 1 %}
            <button class="gallery-nav gallery-prev" onclick="changeImage(-1)" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="gallery-nav gallery-next" onclick="changeImage(1)" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>

            <div class="gallery-counter">
                <span id="currentImageNum">1</span> / {{ artwork.images|length }}
            </div>
            {% endif %}
        </div>

        {% if artwork.images|length > 1 %}
        <div class="gallery-thumbnails">
            {% for image in artwork.images %}
            <div class="thumbnail-wrapper">
                <img src="/art/uploads/{{ image.filename }}"
                     alt="{{ artwork.title }}"
                     class="gallery-thumbnail {% if loop.index0 == 0 %}active{% endif %}"
                     onclick="setImage({{ loop.index0 }})"
                     oncontextmenu="return false;">
                {% if is_owner and artwork.images|length > 1 %}
                <button class="thumbnail-delete"
                        onclick="event.stopPropagation(); deleteImage({{ image.id }}, '{{ image.filename }}')"
                        title="Delete this image">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">×</button>
        <img id="lightboxImage" src="" alt="" onclick="event.stopPropagation()">

        {% if artwork.images|length > 1 %}
        <button class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); changeLightboxImage(-1)" aria-label="Previous">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <button class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); changeLightboxImage(1)" aria-label="Next">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
        {% endif %}
    </div>
    
    {% if is_owner %}
    <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border-left: 4px solid var(--primary-purple);">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">You are viewing this as the owner.</p>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="/art/{{ artwork.artist.username }}" class="btn btn-secondary btn-small">Back to Gallery</a>
            <form method="POST" action="/art/{{ artwork.artist.username }}/{{ artwork.slug }}/delete" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this artwork? This cannot be undone.');">
                <button type="submit" class="btn btn-small" style="background: #EF4444; color: white; border: none; cursor: pointer;">Delete Artwork</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Image gallery data
const images = [
    {% for image in artwork.images %}
    "/art/uploads/{{ image.filename }}"{% if not loop.last %},{% endif %}
    {% endfor %}
];
let currentImageIndex = 0;

// Delete individual image
function deleteImage(imageId, filename) {
    if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
        return;
    }

    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/art/{{ artwork.artist.username }}/{{ artwork.slug }}/delete-image/' + imageId;
    document.body.appendChild(form);
    form.submit();
}

// Change main image
function setImage(index) {
    currentImageIndex = index;
    document.getElementById('mainImage').src = images[index];
    document.getElementById('currentImageNum').textContent = index + 1;

    // Update thumbnail active state
    document.querySelectorAll('.gallery-thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
    });
}

function changeImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    setImage(currentImageIndex);
}

// Lightbox functions
function openLightbox(index) {
    currentImageIndex = index;
    document.getElementById('lightboxImage').src = images[index];
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
}

function changeLightboxImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    document.getElementById('lightboxImage').src = images[currentImageIndex];
    setImage(currentImageIndex); // Also update main gallery
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    if (lightbox.classList.contains('active')) {
        if (e.key === 'Escape') {
            closeLightbox();
        } else if (e.key === 'ArrowLeft') {
            changeLightboxImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeLightboxImage(1);
        }
    } else {
        if (e.key === 'ArrowLeft') {
            changeImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeImage(1);
        }
    }
});

// Touch/swipe support
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            // Swipe left - next image
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('active')) {
                changeLightboxImage(1);
            } else {
                changeImage(1);
            }
        } else {
            // Swipe right - previous image
            const lightbox = document.getElementById('lightbox');
            if (lightbox.classList.contains('active')) {
                changeLightboxImage(-1);
            } else {
                changeImage(-1);
            }
        }
    }
}

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

// Disable right-click on images
document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'IMG') {
        e.preventDefault();
        return false;
    }
});

// Disable drag on images
document.querySelectorAll('img').forEach(img => {
    img.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
    });
});
</script>
{% endblock %}

